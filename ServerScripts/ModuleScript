local module = {}
local Players = game:GetService("Players")
local tweenService = game:GetService("TweenService")
local tweenInfo2 = TweenInfo.new(0.15, Enum.EasingStyle.Quint, Enum.EasingDirection.InOut)
local meterEvent = game.ReplicatedStorage.RemoteEvents.UIEvents.MeterEvent
local rs = game.ReplicatedStorage

module.damageLooks = function(player, v, damage)
	
	player.Character:SetAttribute("TotalDamage", player.Character:GetAttribute("TotalDamage") + damage)
	task.spawn(function()
		local curDmg = player.Character:GetAttribute("TotalDamage")
		task.wait(2)
		if player.Character then if curDmg == player.Character:GetAttribute("TotalDamage") then
			player.Character:SetAttribute("TotalDamage", 0)
		end end
	end)

	meterEvent:FireClient(player)
	local target = v.Parent 
	local highlight = Instance.new("Highlight")
	highlight.Adornee = target
	highlight.FillColor = Color3.new(1, 0, 0) 
	highlight.FillTransparency = 0.4
	highlight.OutlineTransparency = 1
	highlight.Parent = target
	highlight.DepthMode = Enum.HighlightDepthMode.Occluded 
	game.Debris:AddItem(highlight, 0.2)
	
	local healthLost = damage

	--local hum = v.Parent:FindFirstChild("Humanoid")
	local damageIndicatorGui = Instance.new("BillboardGui")
	damageIndicatorGui.AlwaysOnTop = true

	damageIndicatorGui.Size = UDim2.new(1.5, 0, 1.5, 0)

	local offsetX = math.random(-10, 10)/10
	local offsetY = math.random(-10, 10)/10
	local offsetZ = math.random(-10, 10)/10
	damageIndicatorGui.StudsOffset = Vector3.new(offsetX, offsetY, offsetZ)

	local damageIndicatorLabel = Instance.new("TextLabel")

	damageIndicatorLabel.AnchorPoint = Vector2.new(0.5, 0.5)
	damageIndicatorLabel.Position = UDim2.new(0.5, 0, 0.5, 0)

	damageIndicatorLabel.TextScaled = true
	damageIndicatorLabel.BackgroundTransparency = 1
	--damageIndicatorLabel.FontFace = Font.new("rbxasset://fonts/families/PressStart2P.json")
	damageIndicatorLabel.FontFace = Font.new("rbxasset://fonts/families/PressStart2P.json")
	damageIndicatorLabel.TextStrokeTransparency = 0

	damageIndicatorLabel.Text = healthLost

	damageIndicatorLabel.Size = UDim2.new(0, 0, 0, 0)
	damageIndicatorLabel.TextColor3 = Color3.fromRGB(255, 0, 0)


	damageIndicatorLabel.Parent = damageIndicatorGui

	if v.Parent and v.Parent.PrimaryPart then
		damageIndicatorGui.Parent = v.Parent.PrimaryPart
	end

	damageIndicatorLabel:TweenSize(UDim2.new(1.3, 0, 1.3, 0), "InOut", "Quint", 0.3)

	task.spawn(function()
		wait(0.1)
		damageIndicatorLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
		wait(0.1)
		damageIndicatorLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
		wait(0.1)
		damageIndicatorLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
		wait(0.1)
		damageIndicatorLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
		wait(0.1)
		damageIndicatorLabel.TextColor3 = Color3.fromRGB(255, 0, 0)

	end)
	task.spawn(function()

		wait(0.2)
		if player.Character:GetAttribute("Combo") % 2 == 0 then
			local guiUpTween = tweenService:Create(damageIndicatorGui, tweenInfo2, {StudsOffset = damageIndicatorGui.StudsOffset + Vector3.new(-2.3, 3, 0)})
			local guiDownTween = tweenService:Create(damageIndicatorGui, tweenInfo2, {StudsOffset = damageIndicatorGui.StudsOffset + Vector3.new(-2.3, -6, 0)})
			local textFadeTween = tweenService:Create(damageIndicatorLabel, tweenInfo2, {TextTransparency = 1})
			guiUpTween:Play()
			wait(0.15)
			guiDownTween:Play()
			textFadeTween:Play()
		else
			local guiUpTween = tweenService:Create(damageIndicatorGui, tweenInfo2, {StudsOffset = damageIndicatorGui.StudsOffset + Vector3.new(2.3, 3, 0)})
			local guiDownTween = tweenService:Create(damageIndicatorGui, tweenInfo2, {StudsOffset = damageIndicatorGui.StudsOffset + Vector3.new(2.3, -6, 0)})
			local textFadeTween = tweenService:Create(damageIndicatorLabel, tweenInfo2, {TextTransparency = 1})
			guiUpTween:Play()
			wait(0.15)
			guiDownTween:Play()
			textFadeTween:Play()
		end




		game:GetService("Debris"):AddItem(damageIndicatorGui, 0.3)
	end)
end

module.Outline = function(char)
	local target = char
	local highlight = Instance.new("Highlight")
	highlight.Adornee = target
	highlight.FillColor = Color3.new(1, 0, 0) 
	highlight.FillTransparency = 0.4
	highlight.OutlineTransparency = 1
	highlight.Parent = target
	highlight.DepthMode = Enum.HighlightDepthMode.Occluded 
	game.Debris:AddItem(highlight, 0.2)
end

module.createHitEffect = function(position, hitEffectt, target)
	task.spawn(function()
		local hitEffectSpawn = hitEffectt:Clone()
		hitEffectSpawn.Parent = game.Workspace
		hitEffectSpawn.Position = position
		if target ~= nil then
			hitEffectSpawn.CFrame = CFrame.lookAt(position, target)
		end
		
		game:GetService("Debris"):AddItem(hitEffectSpawn, 0.5)
		task.wait(0.1)

		for _, v in pairs(hitEffectSpawn:GetChildren()) do
			for _, j in pairs(v:GetChildren()) do
				if j:IsA("ParticleEmitter") then
					j:Emit(j:GetAttribute("EmitCount"))
				end
			end
			
		end
	end)

end
module.yieldAllBut = function(char, anim)
	local hum = char.Humanoid
	if char:GetAttribute("Hyperarmor") == false then
		for i, v in pairs(hum.Animator:GetPlayingAnimationTracks()) do
			--
			if v.Name ~= anim and v.Priority ~= Enum.AnimationPriority.Idle then
				v:Stop(0.1)
				--print(v.Priority)
			end
		end
	end
end

module.checkInterruption = function(char, timeDelay)
	local canContinue = true
	
	if char:GetAttribute("Stunned") then
		canContinue = false
		return canContinue
	end
	local connection
	connection = char:GetAttributeChangedSignal("Stunned"):Connect(function()
		local isStunned = char:GetAttribute("Stunned")
		if isStunned == true then
			canContinue = false
		end

		if not char then
			connection:Disconnect()
		end
	end)
	
	task.wait(timeDelay)
	connection:Disconnect()
	connection = nil
	return canContinue
	
end

module.stun = function(vChar, duration)
	
	local hum = vChar.Humanoid
	
	if vChar:GetAttribute("Ragdolled") == false and vChar:GetAttribute("Hyperarmor") == false then
		if hum then
			for i, v in pairs(hum.Animator:GetPlayingAnimationTracks()) do
				v:Stop(0.1)
			end
			
			local hurtAnim = rs.HurtAnims["hurtAnim (1)"]
			local hurtClip = hum.Animator:LoadAnimation(hurtAnim)
			hurtClip.Priority = Enum.AnimationPriority.Action

			hurtClip:Play()
		end
		
	end
	
	if vChar:GetAttribute("Stunned") == true then
		if duration < vChar:GetAttribute("StunnedTime") then 
			return 
		end
	end
	
	
	vChar:SetAttribute("Stunned", true)
	vChar:SetAttribute("StunnedTime", duration)
	if not game.Workspace.AttributeStatePlayers.StunnedPlayers:FindFirstChild(vChar.Name.."Stun") then
		local tag = Instance.new("ObjectValue")
		tag.Name = vChar.Name.."Stun"
		tag.Value = vChar
		tag.Parent = game.Workspace.AttributeStatePlayers.StunnedPlayers
		
	end
end

module.unstun = function(char)
	
	if char:GetAttribute("Stunned") == true then
		local tag = game.Workspace.AttributeStatePlayers.StunnedPlayers:FindFirstChild(char.Name)
		if tag then
			tag:Destroy()
		end
	end
	if char then 
		char:SetAttribute("Stunned", false)
		char:SetAttribute("StunnedTime", 0)
		local hum = char.Humanoid
		if hum then
			char.Humanoid.WalkSpeed = char:GetAttribute("Speed")
			char.Humanoid.JumpPower = 50
			local player = game:GetService("Players"):GetPlayerFromCharacter(char)
			if player then
				rs.RemoteEvents.MovementEvents.MoveEndEvent:FireClient(player)
			end
		end
		
	end
	
end

module.applyAttackingState = function(char, duration)
	if char:GetAttribute("Attacking") == true then
		if duration < char:GetAttribute("AttackingTime") then 
			--print("NoGo")
			return 
		end
	end


	char:SetAttribute("Attacking", true)
	char:SetAttribute("AttackingTime", duration)
	if not game.Workspace.AttributeStatePlayers.AttackingPlayers:FindFirstChild(char.Name.."Attacking") then
		local tag = Instance.new("ObjectValue")
		tag.Name = char.Name.."Attacking"
		tag.Value = char
		tag.Parent = game.Workspace.AttributeStatePlayers.AttackingPlayers

	end
end

module.removeAttackingState = function(char)
	
	if char:GetAttribute("Attacking") == true then
		local tag = game.Workspace.AttributeStatePlayers.AttackingPlayers:FindFirstChild(char.Name.."Attacking")
		if tag then
			tag:Destroy()
		end
	end
	
	char:SetAttribute("Attacking", false)
	char:SetAttribute("AttackingTime", 0)
	local hum = char.Humanoid
	if hum then
		hum.WalkSpeed = char:GetAttribute("Speed")
		hum.JumpPower = 50
		local player = game:GetService("Players"):GetPlayerFromCharacter(char)
		if player then
			rs.RemoteEvents.MovementEvents.MoveEndEvent:FireClient(player)
		end
	end
end

module.checkAll = function(player)
	if player.Character:GetAttribute("Dashing") == false and player.Character:GetAttribute("Driving") == false and player.Character:GetAttribute("Parrying") == false and player.Character:GetAttribute("Busy") == false and player.Character:GetAttribute("Blocking") == false and player.Character:GetAttribute("Stunned") == false then--and player.Character:GetAttribute("Attacking") == false then
		return true
	else
		return false
	end
end



module.knockback = function(ourChar, enemyChar, force)
	
	local hrp = ourChar.PrimaryPart
	local ehrp = enemyChar.PrimaryPart
	if hrp and ehrp then
		
		local lv = Instance.new("LinearVelocity")
		lv.Attachment0 = ehrp:FindFirstChild("RootAttachment") or Instance.new("Attachment", ehrp)
		lv.MaxForce = 1e5
		lv.VectorVelocity = ourChar.PrimaryPart.CFrame.LookVector * force + Vector3.new(0, 0, 0)
		lv.Parent = enemyChar.PrimaryPart
		game.Debris:AddItem(lv, 0.15)
	end
	
end

module.displayText = function(player, message)
	local character = player.Character
	if not character then return end

	local head = character:FindFirstChild("Head")
	if not head then return end

	local bubble = Instance.new("BillboardGui")
	bubble.Size = UDim2.new(0, 150, 0, 37.5)
	bubble.Adornee = head
	bubble.AlwaysOnTop = true
	bubble.Name = "ChatBubble"
	bubble.StudsOffset = Vector3.new(0, 2.5, 0)

	local textLabel = Instance.new("TextLabel")
	textLabel.Size = UDim2.new(1, 0, 1, 0)
	textLabel.BackgroundTransparency = 1
	textLabel.TextScaled = true
	textLabel.FontFace = Font.new("rbxasset://fonts/families/PressStart2P.json")
	textLabel.Text = message
	textLabel.TextColor3 = Color3.new(1, 1, 1)
	textLabel.Parent = bubble

	bubble.Parent = head
	
	task.spawn(function()
		for i = 1, 2 do
			wait(0.1)
			textLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
			wait(0.1)
			textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
			wait(0.1)
			textLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
			wait(0.1)
			textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
			wait(0.1)
			textLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
			wait(0.1)
			textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
			wait(0.1)
			textLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
			wait(0.1)
			textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
			wait(0.1)
		end
	end)


	game:GetService("Debris"):AddItem(bubble, 2)
end
module.blockbreak = function(enemyChar)
	module.yieldAllBut(enemyChar, "")
	enemyChar:SetAttribute("Blocking", false)
	enemyChar:SetAttribute("Speed", 16 + enemyChar:GetAttribute("SpeedBuff"))
	enemyChar.Humanoid.WalkSpeed = enemyChar:GetAttribute("Speed") + enemyChar:GetAttribute("SpeedBuff")
end
module.setCollisionGroup = function(char, dur)

	task.spawn(function()
		for _, descendant in char:GetDescendants() do
			if descendant:IsA("BasePart") then
				descendant.CollisionGroup = "TempNoCollide"
			end
		end
		task.wait(dur)
		for _, descendant in char:GetDescendants() do
			if descendant:IsA("BasePart") then
				descendant.CollisionGroup = "Default"
			end
		end
	end)
	

end


return module
