local players = game:GetService("Players")
local redOutline = game:GetService("ReplicatedStorage").redOutline
local m1Event = game:GetService("ReplicatedStorage").RemoteEvents.CombatEvents.M1
local m1Script = game.StarterPlayer.StarterCharacterScripts.Controller.LocalCombat
local tweenService = game:GetService("TweenService")

local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quint, Enum.EasingDirection.InOut)
local tweenInfo2 = TweenInfo.new(0.15, Enum.EasingStyle.Quint, Enum.EasingDirection.InOut)
local tweenInfo3 = TweenInfo.new(0.6, Enum.EasingStyle.Quint, Enum.EasingDirection.InOut)
local meterEvent = game:GetService("ReplicatedStorage").RemoteEvents.UIEvents.MeterEvent
local blockEvent = game:GetService("ReplicatedStorage").RemoteEvents.CombatEvents.BlockEvent

--m1Functions
local rs = game:GetService("ReplicatedStorage")
local m1IdleFunction = rs.BindableFunctions.M1Function
local hitEffectTemplate = rs:WaitForChild("VFX").CombatVFX:WaitForChild("RedFX")

local possibleParts = {"Torso", "Head", "Left Arm", "Right Arm", "Left Leg", "Right Leg"}
local activateM1Event = rs.RemoteEvents.CombatEvents.ActivateM1Event
local modScript = require(game.ServerScriptService.ModuleScript)
local ragdollModule = require(game.ServerScriptService.ragdollModule)
local combatAnimModule = require(script.combatAnimsModule)


local function yieldAllBut(hum, anim)
	for i, v in pairs(hum:GetPlayingAnimationTracks()) do

		if v.Name ~= anim and v.Name ~= "idleAnim" then
			v:Stop()
			v:Destroy()
		end
	end
end
local segments = 10
local radius = 10
local yOffset = 0.1

local spawnFlyParts = function(hit)
	local debris = game:GetService("Debris")
	local radius = 5
	local segments = 20
	local center = hit.Parent.PrimaryPart.Position

	for i = 1, segments do
		local angle = (2 * math.pi / segments) * i
		local x = math.cos(angle) * radius
		local z = math.sin(angle) * radius
		local pos = center + Vector3.new(x, -3, z)
		local newSize = math.random(0.2, 1.8)
		local part = Instance.new("Part")
		part.Size = Vector3.new(newSize, newSize, newSize)
		part.Position = pos
		part.CFrame = CFrame.lookAt(pos, center)
		part.Anchored = false
		part.CanCollide = true
		part.Material = Enum.Material.Basalt
		part.Color = Color3.fromRGB(60, 60, 60)

		part.AssemblyAngularVelocity = Vector3.new(math.random(), math.random(), math.random()) * 10 -- spin
		local outwardDir = (pos - center).Unit
		local upwardDir = Vector3.new(0, 1, 0)
		local burstDir = (outwardDir + upwardDir).Unit


		part.AssemblyLinearVelocity = burstDir * math.random(25, 35)
		part.Parent = workspace

		debris:AddItem(part, 3)
	end
end

local spawnCircleParts = function(hit)
	local tInfo = TweenInfo.new(0.2, Enum.EasingStyle.Linear, Enum.EasingDirection.In)
	for i = 1, segments do
		local angle = (2 * math.pi / segments) * i
		local x = math.cos(angle) * radius
		local z = math.sin(angle) * radius
		local yRot = math.random(20, 45)
		local pos = hit.Parent.PrimaryPart.Position + Vector3.new(x, -3, z)



		local part = Instance.new("Part")
		part.Size = Vector3.new(math.random(1.5, 3.5), math.random(1, 2), math.random(1, 3))
		part.CFrame = CFrame.lookAt(hit.Parent.PrimaryPart.Position + Vector3.new(0, -2, 0), pos)
		part.CFrame *= CFrame.Angles(math.rad(math.random(0, 45)), 0, 0)
		part.Position = pos
		part.Anchored = true
		part.CanCollide = false
		part.Material = Enum.Material.Basalt
		part.Color = Color3.fromRGB(60, 60, 60)
		part.Parent = workspace
		game:GetService("Debris"):AddItem(part, 4)
		local tween = tweenService:Create(part, tInfo, {Position = part.Position + Vector3.new(0, 1, 0)}):Play()
		task.spawn(function()
			task.wait(4)
			local tween2 = tweenService:Create(part, tInfo, {Position = part.Position + Vector3.new(0, -3, 0)}):Play()
		end)


	end
end

local function hitbox(position)

	local hitbox = Instance.new("Part")
	hitbox.Size = Vector3.new(5, 6, 5)
	hitbox.Transparency = 1
	hitbox.CanCollide = false
	hitbox.CanQuery = false
	hitbox.Anchored = true
	hitbox.BrickColor = BrickColor.new("Bright red")
	hitbox.Parent = workspace
	hitbox.Position = position
	hitbox.Name = "Hitbox"

	game:GetService("Debris"):AddItem(hitbox, 0.3)
	return hitbox

end

local function castHitbox(player)

	local character = player.Character
	local canDo = false

	local rootPart = character.PrimaryPart
	if rootPart then
		local position = rootPart.Position + rootPart.CFrame.LookVector * 4
		local hitbox = hitbox(position)

		local hitboxParams = OverlapParams.new()
		hitboxParams.FilterDescendantsInstances = {character, hitbox}
		hitboxParams.FilterType = Enum.RaycastFilterType.Exclude
		hitboxParams.MaxParts = 50

		local partsInBox = workspace:GetPartBoundsInBox(hitbox.CFrame, hitbox.Size, hitboxParams)

		local hitPlayers= {}
		for _, v in partsInBox do
			local hum = v.Parent:FindFirstChild("Humanoid")

			if hum and not hitPlayers[v.Parent] then	

				hitPlayers[v.Parent] = true
				local damage = 0

				if v.Parent:GetAttribute("Parrying") == true then

					local parryFX = rs.VFX.CombatVFX.parryFX:Clone()


					local arm = v.Parent:FindFirstChild("Left Arm")
					if arm then
						local armForward = arm.CFrame.RightVector
						parryFX.Position = arm.Position + armForward *1
						local m6D = Instance.new("Motor6D")
						m6D.Parent = arm
						m6D.Part0 = arm
						m6D.Part1 = parryFX
						m6D.C1 = CFrame.new(0, 0, 1)
						game:GetService("Debris"):AddItem(m6D, 3)
					end

					parryFX.Parent = game.Workspace
					task.wait(0.1)
					for _, att in pairs(parryFX:GetChildren()) do
						for _, emitter in pairs(att:GetChildren()) do
							emitter:Emit(emitter:GetAttribute("EmitCount"))
						end
					end
					game:GetService("Debris"):AddItem(parryFX, 3)

					modScript.stun(player.Character, 0.8)
					modScript.stun(v.Parent, 0.6)

				elseif v.Parent:GetAttribute("Blocking") == true then

					if player.Character:GetAttribute("Combo") == 5 then
						damage = 8
						modScript.blockbreak(v.Parent)
						--modScript.yieldAllBut(v.Parent, "f")
						modScript.createHitEffect(v.Parent.PrimaryPart.Position + Vector3.new(0, 0.9, -1.5), hitEffectTemplate)
						modScript.stun(v.Parent, 2)
					else
						damage = 2
					end


				else
					damage  = 5 + (1*(player.Stats.Strength.Value*0.3))
					if player.Character:GetAttribute("Combo") == 5 then
						if player.Character:GetAttribute("Airtilting") == 1 then
							modScript.stun(v.Parent, 1.5)
							local lv = v.Parent.PrimaryPart:FindFirstChild("UptiltLv")
							if lv then
								
								local origin = rootPart.Position
								local direction = Vector3.new(rootPart.CFrame.LookVector.X, -0.65, rootPart.CFrame.LookVector.Z).Unit * 100

								local raycastParams = RaycastParams.new()
								raycastParams.FilterType = Enum.RaycastFilterType.Exclude
								raycastParams.FilterDescendantsInstances = {player.Character, v.Parent} 

								local result = workspace:Raycast(origin, direction, raycastParams)

								if result and result.Instance then
									local hurtAnim = rs.HurtAnims.groundSlamHurtAnim
									local clip = v.Parent.Humanoid.Animator:LoadAnimation(hurtAnim)
									clip:Play()
									task.delay(1.2, function()
										clip:Stop()
									end)
									
									
									local distance = (result.Position-v.Parent.PrimaryPart.Position).Magnitude
									local speed = 90
									local timeDelay = distance/speed
									lv.VectorVelocity = (result.Position - v.Parent.PrimaryPart.Position).Unit * speed
									task.delay(timeDelay, function()
										task.spawn(function()
											lv.VectorVelocity = Vector3.new(0, 0, 0)
											task.wait(0.1)
											lv:Destroy()
										end)
										
										ragdollModule:Ragdoll(v.Parent, 1.2)
										modScript.stun(v.Parent, 1.2)
										modScript.removeAttackingState(character)
										spawnFlyParts(v)
										spawnCircleParts(v)

										local debrisVFX = rs.VFX.CombatVFX.ExplosionDebris:Clone()
										debrisVFX.Parent = game.Workspace
										debrisVFX.Position = v.Parent.PrimaryPart.Position
										game.Debris:AddItem(debrisVFX, 2)
										task.wait(0.05)
										debrisVFX.Attachment.Dust:Emit(debrisVFX.Attachment.Dust:GetAttribute("EmitCount"))
										
										local debris = rs.VFX.testDebris:Clone()
										debris.Parent = player.Character
										debris.Attachment.Dust.Color = ColorSequence.new(result.Instance.Color)
										debris.Position = v.Parent.PrimaryPart.Position
										task.wait(0.01)
										debris.Attachment.Dust:Emit(5)
										debris.Attachment.Crescents.Color = ColorSequence.new(result.Instance.Color)
										debris.Attachment.Crescents:Emit(6)
										game:GetService("Debris"):AddItem(debris, 1)
									end)
									local myLv = rootPart:FindFirstChild("UptiltLv")
									if myLv then
										myLv:Destroy()
									end
								end
							end
							
						else
							modScript.knockback(character, v.Parent, 30)
							ragdollModule:Ragdoll(v.Parent, 1.5)
							modScript.stun(v.Parent, 1.5)
						end
						
						damage = 8+ (1*(player.Stats.Strength.Value*0.3))
							
						modScript.createHitEffect(hum.Parent.PrimaryPart.Position + Vector3.new(0, 0.7, 0), hitEffectTemplate)
					else
						if player.Character:GetAttribute("Combo") > 2 then
							if player.Character:GetAttribute("Airtilting") == 0 then
								player.Character:SetAttribute("Airtilting", 1)
								local lv = Instance.new("LinearVelocity")
								lv.Name = "UptiltLv"
								lv.Attachment0 = rootPart:FindFirstChild("RootAttachment") or Instance.new("Attachment", rootPart)
								lv.MaxForce = 1e10
								lv.VectorVelocity = Vector3.new(0, 70, 0)
								lv.Parent = rootPart
								
								modScript.setCollisionGroup(v.Parent,0.15)
								modScript.setCollisionGroup(player.Character, 0.15)
								task.delay(0.15, function()
									lv.VectorVelocity = Vector3.new(0, 0, 0)
									local humanoid = player.Character.Humanoid
									local connection
									connection = game:GetService("RunService").Stepped:Connect(function()
										if lv then
											local horizontal = Vector3.new(
												humanoid.MoveDirection.X,
												0,
												humanoid.MoveDirection.Z
											) * humanoid.WalkSpeed

											
											lv.VectorVelocity = horizontal
										else
											connection:Disconnect()
											connection = nil
										end
									end)
								end)
								
								
								local lv2 = Instance.new("LinearVelocity")
								lv2.Name = "UptiltLv"
								game.Debris:AddItem(lv2, 3)
								lv2.Attachment0 = v.Parent.PrimaryPart:FindFirstChild("RootAttachment") or Instance.new("Attachment", v.Parent.PrimaryPart)
								lv2.MaxForce = 1e10
								lv2.VectorVelocity = Vector3.new(0, 70, 0)
								lv2.Parent = v.Parent.PrimaryPart
								--game.Debris:AddItem(lv, 0.07)
								task.delay(0.15, function()
									lv2.VectorVelocity = Vector3.new(0, 0, 0)
								end)
								
							end
						end
						modScript.stun(v.Parent, 0.8)
						modScript.knockback(character, v.Parent, 10)
						modScript.createHitEffect(hum.Parent.PrimaryPart.Position + Vector3.new(0, 0.7, 0), hitEffectTemplate)
					end

					--yieldAllBut(v.Parent:FindFirstChild("Humanoid"), " ")
					local health = v.Parent:FindFirstChild("Humanoid").Health
				end

				modScript.damageLooks(player, v, damage)
				hum:TakeDamage(damage)
				rs.RemoteEvents.NPCEvents.EnemyEvents.UpdateContributors:FireClient(player, hum.Parent, damage)
			end
		end


	end
end


activateM1Event.OnServerEvent:Connect(function(player)
	player.Character:SetAttribute("M1Activated", not player.Character:GetAttribute("M1Activated"))
	print(player.Character:GetAttribute("M1Activated"))
end)

local m1Speed = 0.25
m1Event.OnServerEvent:Connect(function(player)
	

	
	local character = player.Character or player.CharacterAdded:Wait()
	local humanoid = character:WaitForChild("Humanoid")
	local runService = game:GetService("RunService")
	local m1Active = false
	local animator = humanoid:WaitForChild("Animator")
	local rs = game:GetService("ReplicatedStorage")
	local damage = 1
	local cooldown = 0.5
	local m1IdleFunction = rs.BindableFunctions.M1Function
	local possibleParts = {"Torso", "Head", "Left Arm", "Right Arm", "Left Leg", "Right Leg"}
	local hurtAnim1 = game:GetService("ReplicatedStorage").HurtAnims["hurtAnim (1)"]
	local hurtAnim2 = game:GetService("ReplicatedStorage").HurtAnims["hurtAnim (2)"]
	local anims = combatAnimModule:GetAnimations(player.Character)
	local last = 2


	local m1Count = player:GetAttribute("Combo")
	local humanoidRootPart = character.PrimaryPart
	

	


	--local checks = modScript.checkAll(player)
	if player.Character:GetAttribute("Stunned") == true or player.Character:GetAttribute("Cooldown") == true or player.Character:GetAttribute("Blocking") == true or player.Character:GetAttribute("Charging") == true or player.Character:GetAttribute("Busy") == true then return end
		
		player.Character:SetAttribute("Cooldown", true)
		player.Character:SetAttribute("Busy", true)
		task.delay(m1Speed, function()
			player.Character:SetAttribute("Busy", false)
		end)
		modScript.applyAttackingState(player.Character, 0.7)
		player.Character:SetAttribute("Sprinting", false)
		
		
		
		player.Character:SetAttribute("Speed", 4)
		local originalJumpHeight = player.Character.Humanoid.JumpHeight
		player.Character.Humanoid.JumpPower = 0
		
		
		yieldAllBut(player.Character.Humanoid, "M1 "..player.Character:GetAttribute("Combo"))
		--print(player.Character:GetAttribute("Combo"))
		anims["M1_"..player.Character:GetAttribute("Combo")]:Play()
		modScript.knockback(player.Character, player.Character, 10)
		task.spawn(function()
			if player.Character:GetAttribute("Combo") < 5  then
				task.wait(m1Speed)
				player.Character:SetAttribute("Cooldown", false)
			
			else	
				task.wait(2)
				if player.Character then player.Character:SetAttribute("Cooldown", false) end
				
			end
		end)
		task.wait(0.14)
		if player.Character:GetAttribute("Stunned") == false then

			castHitbox(player)
		end
		
		if player.Character:GetAttribute("Combo") == 5 then
			player.Character:SetAttribute("Combo", 1)
		else
			player.Character:SetAttribute("Combo", player.Character:GetAttribute("Combo")+1)
		end
		
		task.spawn(function()
			local prev = player.Character:GetAttribute("Combo")
			task.wait(1.5)
			if player.Character then if prev == player.Character:GetAttribute("Combo") then
				local lv = player.Character.PrimaryPart:FindFirstChild("UptiltLv")
				if lv then
					lv:Destroy()
				end
			end 
			task.wait(1)
			if player.Character then 
				if prev == player.Character:GetAttribute("Combo") then
					player.Character:SetAttribute("Combo", 1)
					player.Character.Humanoid.JumpPower = 50
				end
			end 
		end
		end)
		
	
	
end)


local wantToBlock = false

blockEvent.OnServerEvent:Connect(function(player)
	--print("Blocking")
	if player.Character:GetAttribute("Stunned") == true or player.Character:GetAttribute("Attacking") == true or player.Character:GetAttribute("Dashing") == true or player.Character:GetAttribute("Busy") == true then return end
	
	local character = player.Character
	local anims = combatAnimModule:GetAnimations(player.Character)
	yieldAllBut(character.Humanoid, "fdsfdsfd")

	task.spawn(function()
		wantToBlock = true
		character:SetAttribute("Parrying", true)
		anims.parry:Play()
		
		
		
		task.wait(anims.parry.Length)
		if wantToBlock == true then
			character:SetAttribute("Blocking", true)
			character:SetAttribute("Parrying", false)
			anims.block:Play()
		else
			character:SetAttribute("Blocking", false)
			character:SetAttribute("Parrying", false)
			character:SetAttribute("Speed", 16)
			character.Humanoid.WalkSpeed = character:GetAttribute("Speed")+character:GetAttribute("SpeedBuff")
		end
		
	end)
	if character:GetAttribute("Sprinting") == true then
		character:SetAttribute("Sprinting", false)
	end
	character:SetAttribute("Speed", 4)
	character.Humanoid.WalkSpeed = character:GetAttribute("Speed")+character:GetAttribute("SpeedBuff")
end)

rs.RemoteEvents.CombatEvents.UnblockEvent.OnServerEvent:Connect(function(player)
	local character = player.Character
	wantToBlock = false
	
	if character:GetAttribute("Parrying") == false and character:GetAttribute("Blocking") == true then
		character:SetAttribute("Blocking", false)
		character:SetAttribute("Parrying", false)
		character:SetAttribute("Speed", 16)
		character.Humanoid.WalkSpeed = character:GetAttribute("Speed")+character:GetAttribute("SpeedBuff")
		yieldAllBut(character.Humanoid, "fdsfdsfdsfs")
	end
	
	
end)



rs.RemoteEvents.CombatEvents.AirtiltEvent.OnServerEvent:Connect(function(player)
	if player.Character:GetAttribute("Airtilting") == -1 then
		player.Character:SetAttribute("Airtilting", 0)
	end
	
	task.delay(2, function()
		if player.Character:GetAttribute("Attacking") == false then
			player.Character:SetAttribute("Airtilting", -1)
		end
	end)
end)
